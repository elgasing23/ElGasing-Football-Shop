<nav class="fixed top-0 left-0 w-full z-50 bg-slate-900 text-white shadow-md">
  <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between flex-wrap">
    <div class="flex items-center gap-2">
      <a href="/" class="text-lg font-bold hover:text-blue-400">ELGASING</a>
    </div>

    <button class="block md:hidden text-2xl" onclick="document.getElementById('nav-menu').classList.toggle('hidden')">
      â˜°
    </button>

    <!-- Menu -->
    <ul id="nav-menu" class="hidden md:flex flex-col md:flex-row md:items-center gap-4 w-full md:w-auto mt-3 md:mt-0">
      {% if user.is_authenticated %}
        <li class="md:hidden border-t border-slate-700 pt-2 mt-2">
          <p class="text-sm">Welcome, {{ name|default:user.username }}</p>
          <p class="text-xs">{{ npm|default:"Student" }} - {{ class|default:"Class" }}</p>
          <button data-logout-button class="w-full mt-2 bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm text-center">Logout</button>
        </li>
      {% else %}
        <li class="md:hidden border-t border-slate-700 pt-2 mt-2 flex gap-2">
          <a href="{% url 'main:login' %}" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm text-center">Login</a>
          <a href="{% url 'main:register' %}" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm text-center">Register</a>
        </li>
      {% endif %}
    </ul>

    <!-- User Dropdown -->
    {% if user.is_authenticated %}
      <div class="relative hidden md:block">
        <button id="user-btn" class="p-2 hover:text-blue-400 focus:outline-none">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path fill-rule="evenodd" d="M12 12c2.485 0 4.5-2.015 4.5-4.5S14.485 3 12 3 7.5 5.015 7.5 7.5 9.515 12 12 12zm-7.5 9a7.5 7.5 0 0115 0H4.5z" clip-rule="evenodd"/>
          </svg>
        </button>

        <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white text-gray-800 rounded-md shadow-lg overflow-hidden z-20">
          <div class="px-4 py-2 text-sm border-b">
            <p class="font-semibold">Welcome, {{ name|default:user.username }}</p>
            <p class="text-xs">{{ npm|default:"Student" }} - {{ class|default:"Class" }}</p>
          </div>
          <button data-logout-button class="block w-full text-left px-4 py-2 text-sm hover:bg-red-500 hover:text-white">Logout</button>
        </div>
      </div>
    {% else %}
      <div class="hidden md:flex gap-2">
        <a href="{% url 'main:login' %}" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">Login</a>
        <a href="{% url 'main:register' %}" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm">Register</a>
      </div>
    {% endif %}
  </div>
</nav>


<script>
  const userBtn = document.getElementById('user-btn');
  const dropdown = document.getElementById('user-dropdown');

  if (userBtn) {
    userBtn.addEventListener('click', () => {
      dropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!userBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });
  }

  const logoutButtons = document.querySelectorAll('[data-logout-button]');

  function getCsrfToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : '';
  }

  function ensureToastContainer() {
    let container = document.getElementById('toast-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toast-container';
      container.className = 'fixed top-20 right-4 z-[60] flex flex-col gap-3';
      document.body.appendChild(container);
    }
    return container;
  }

  function showNavToast(message, type = 'info') {
    const container = ensureToastContainer();
    const toast = document.createElement('div');
    toast.className = `flex items-center gap-2 px-4 py-3 rounded-lg shadow-md border text-sm bg-white ${type === 'success' ? 'border-green-200 text-green-700' : type === 'error' ? 'border-red-200 text-red-700' : 'border-slate-200 text-slate-700'}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
      toast.classList.add('opacity-0', 'translate-x-4');
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }

  async function parseJsonResponse(response) {
    const contentType = response.headers.get('Content-Type') || '';
    if (contentType.includes('application/json')) {
      return response.json();
    }
    const text = await response.text();
    throw new Error(text || 'Unexpected server response.');
  }

  logoutButtons.forEach((button) => {
    button.addEventListener('click', async (event) => {
      event.preventDefault();
      try {
        const response = await fetch('{% url "main:logout" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify({}),
        });

        const data = await parseJsonResponse(response);

        if (!response.ok) {
          throw new Error(data.message || 'Failed to log out');
        }

        showNavToast('Logged out successfully.', 'success');
        setTimeout(() => {
          window.location.href = data.redirect_url || '{% url "main:login" %}';
        }, 800);
      } catch (error) {
        showNavToast(error.message, 'error');
      }
    });
  });
</script>
