{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Items</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-gray-50 w-full pt-20 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
    <header class="mb-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <p class="text-sm text-slate-500 mb-1">Last login: {{ last_login }}</p>
          <h1 class="text-3xl font-bold text-slate-900">Welcome back, {{ name|default:user.username }}!</h1>
          <p class="text-slate-600">Manage all of your football gear in one dashboard.</p>
        </div>
        <div class="flex flex-wrap gap-3">
          <button id="refresh-button" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-md shadow-sm hover:bg-slate-50 transition">
            <span>Refresh</span>
          </button>
          <button id="create-button" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md shadow hover:bg-blue-700 transition">
            <span>New Item</span>
          </button>
        </div>
      </div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8" id="stats-wrapper">
      <article class="stat-card bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
        <p class="text-sm text-slate-500">Total Items</p>
        <p class="text-2xl font-semibold text-slate-900" id="stat-total">0</p>
      </article>
      <article class="stat-card bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
        <p class="text-sm text-slate-500">My Items</p>
        <p class="text-2xl font-semibold text-slate-900" id="stat-my">0</p>
      </article>
      <article class="stat-card bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
        <p class="text-sm text-slate-500">Featured</p>
        <p class="text-2xl font-semibold text-slate-900" id="stat-featured">0</p>
      </article>
      <article class="stat-card bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
        <p class="text-sm text-slate-500">Most Viewed</p>
        <p class="text-sm font-medium text-slate-900" id="stat-top">No data</p>
      </article>
    </section>

    <section class="bg-white border border-slate-200 rounded-xl shadow-sm">
      <div class="p-4 border-b border-slate-200 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <div class="flex flex-wrap gap-2" id="filter-buttons">
          <button data-filter="all" class="filter-btn px-4 py-2 rounded-md border border-slate-200 bg-blue-600 text-white">All Items</button>
          <button data-filter="my" class="filter-btn px-4 py-2 rounded-md border border-slate-200 bg-white text-slate-700">My Items</button>
          <button data-filter="featured" class="filter-btn px-4 py-2 rounded-md border border-slate-200 bg-white text-slate-700">Featured</button>
        </div>
      </div>

      <div class="p-4">
        <div id="loading-state" class="hidden flex items-center justify-center py-10 text-slate-500">
          <span class="animate-pulse">Loading items...</span>
        </div>

        <div id="error-state" class="hidden border border-red-200 bg-red-50 text-red-700 rounded-lg p-4">
          Something went wrong when loading items. Please try again.
        </div>

        <div id="empty-state" class="hidden text-center py-12">
          <div class="w-32 h-32 mx-auto mb-4">
            <img src="{% static 'image/no-items.png' %}" alt="No items" class="w-full h-full object-contain">
          </div>
          <h3 class="text-lg font-semibold text-slate-900 mb-2">No items yet</h3>
          <p class="text-slate-500 mb-4">Create your first football product to display it here.</p>
          <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition" id="empty-create">Create Item</button>
        </div>

        <div id="items-container" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6"></div>
      </div>
    </section>
  </div>
</div>

<div id="item-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/70">
  <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h2 id="modal-title" class="text-xl font-semibold text-slate-900">Create Item</h2>
        <p id="modal-subtitle" class="text-sm text-slate-500">Fill in the details below to save your item.</p>
      </div>
      <button id="modal-close" class="text-slate-400 hover:text-slate-600">âœ•</button>
    </div>

    <form id="item-form" class="space-y-4">
      <div>
        <label for="item-name" class="block text-sm font-medium text-slate-700">Name</label>
        <input id="item-name" name="name" type="text" required class="mt-1 w-full border border-slate-200 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="item-price" class="block text-sm font-medium text-slate-700">Price</label>
          <input id="item-price" name="price" type="number" min="0" required class="mt-1 w-full border border-slate-200 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="item-category" class="block text-sm font-medium text-slate-700">Category</label>
          <select id="item-category" name="category" class="mt-1 w-full border border-slate-200 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="ball">Ball</option>
            <option value="shoes">Shoes</option>
            <option value="shocks">Shocks</option>
            <option value="jersey">Jersey</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
      <div>
        <label for="item-thumbnail" class="block text-sm font-medium text-slate-700">Thumbnail URL</label>
        <input id="item-thumbnail" name="thumbnail" type="url" placeholder="https://" class="mt-1 w-full border border-slate-200 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label for="item-description" class="block text-sm font-medium text-slate-700">Description</label>
        <textarea id="item-description" name="description" rows="3" class="mt-1 w-full border border-slate-200 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
      </div>
      <div class="flex items-center gap-2">
        <input id="item-featured" name="is_featured" type="checkbox" class="h-4 w-4 text-blue-600 border-slate-300 rounded">
        <label for="item-featured" class="text-sm text-slate-700">Mark as featured</label>
      </div>
      <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
        <button type="button" id="modal-cancel" class="px-4 py-2 rounded-md border border-slate-200 bg-white text-slate-700 hover:bg-slate-50">Cancel</button>
        <button type="submit" id="modal-submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save Item</button>
      </div>
    </form>
  </div>
</div>

<div id="delete-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/70">
  <div class="bg-white rounded-xl shadow-xl max-w-sm w-full p-6">
    <h3 class="text-lg font-semibold text-slate-900 mb-2">Remove this item?</h3>
    <p class="text-sm text-slate-500">This action cannot be undone.</p>
    <div class="flex justify-end gap-3 mt-6">
      <button id="delete-cancel" class="px-4 py-2 rounded-md border border-slate-200 bg-white text-slate-700 hover:bg-slate-50">Cancel</button>
      <button id="delete-confirm" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

<div id="toast-container" class="fixed top-20 right-4 z-[60] flex flex-col gap-3"></div>

<script>
  const updateUrlTemplate = "{% url 'main:update_item_ajax' '00000000-0000-0000-0000-000000000000' %}";
  const deleteUrlTemplate = "{% url 'main:delete_item_ajax' '00000000-0000-0000-0000-000000000000' %}";

  const endpoints = {
    list: "{% url 'main:items_collection' %}",
    create: "{% url 'main:create_item_ajax' %}",
    update: (id) => updateUrlTemplate.replace('00000000-0000-0000-0000-000000000000', id),
    remove: (id) => deleteUrlTemplate.replace('00000000-0000-0000-0000-000000000000', id),
    stats: "{% url 'main:item_stats' %}",
  };

  const filterButtons = document.querySelectorAll('.filter-btn');
  const refreshButton = document.getElementById('refresh-button');
  const createButton = document.getElementById('create-button');
  const emptyCreateButton = document.getElementById('empty-create');
  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const emptyState = document.getElementById('empty-state');
  const itemsContainer = document.getElementById('items-container');
  const toastContainer = document.getElementById('toast-container');

  const itemModal = document.getElementById('item-modal');
  const deleteModal = document.getElementById('delete-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalSubtitle = document.getElementById('modal-subtitle');
  const modalSubmit = document.getElementById('modal-submit');
  const itemForm = document.getElementById('item-form');

  const nameInput = document.getElementById('item-name');
  const priceInput = document.getElementById('item-price');
  const categoryInput = document.getElementById('item-category');
  const thumbnailInput = document.getElementById('item-thumbnail');
  const descriptionInput = document.getElementById('item-description');
  const featuredInput = document.getElementById('item-featured');

  let currentFilter = 'all';
  let editItemId = null;
  let deleteItemId = null;
  const itemsCache = new Map();

  async function parseJsonResponse(response) {
    const contentType = response.headers.get('Content-Type') || '';
    if (contentType.includes('application/json')) {
      return response.json();
    }
    const text = await response.text();
    throw new Error(text || 'Unexpected server response.');
  }

  function getCsrfToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : '';
  }

  function showToast(type, message) {
    const toast = document.createElement('div');
    toast.className = `flex items-center gap-2 px-4 py-3 rounded-lg shadow-md border text-sm bg-white ${type === 'success' ? 'border-green-200 text-green-700' : type === 'error' ? 'border-red-200 text-red-700' : 'border-slate-200 text-slate-700'}`;
    toast.innerHTML = `<span>${message}</span>`;
    toastContainer.appendChild(toast);
    setTimeout(() => {
      toast.classList.add('opacity-0', 'translate-x-4');
      setTimeout(() => toast.remove(), 300);
    }, 2500);
  }

  function formatCurrency(value) {
    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(value);
  }

  function toggleModal(modal, show) {
    modal.classList.toggle('hidden', !show);
  }

  function resetForm() {
    itemForm.reset();
    featuredInput.checked = false;
  }

  async function fetchItems() {
    loadingState.classList.remove('hidden');
    errorState.classList.add('hidden');
    emptyState.classList.add('hidden');
    itemsContainer.innerHTML = '';

    try {
      const response = await fetch(`${endpoints.list}?filter=${currentFilter}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
      });

      if (!response.ok) {
        throw new Error('Failed to fetch items');
      }

      const data = await parseJsonResponse(response);
      renderItems(data);
    } catch (error) {
      console.error(error);
      errorState.classList.remove('hidden');
    } finally {
      loadingState.classList.add('hidden');
    }
  }

  function renderItems(payload) {
    const items = payload.data || [];
    const html = payload.html || '';

    itemsCache.clear();
    items.forEach((item) => itemsCache.set(item.id, item));

    if (!items.length) {
      emptyState.classList.remove('hidden');
      return;
    }

    emptyState.classList.add('hidden');

    itemsContainer.innerHTML = html;
  }

  async function fetchStats() {
    try {
      const response = await fetch(endpoints.stats, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
      });
      if (!response.ok) {
        throw new Error('Failed to fetch stats');
      }
      const { data } = await parseJsonResponse(response);
      document.getElementById('stat-total').textContent = data.total_items;
      document.getElementById('stat-my').textContent = data.my_items;
      document.getElementById('stat-featured').textContent = data.featured_items;
      document.getElementById('stat-top').textContent = data.most_viewed ? `${data.most_viewed.name} (${data.most_viewed.items_views} views)` : 'No data';
    } catch (error) {
      console.error(error);
    }
  }

  async function submitItem(url, method, payload, successMessage) {
    const response = await fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken(),
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: JSON.stringify(payload),
    });

    let data;
    try {
      data = await parseJsonResponse(response);
    } catch (error) {
      throw new Error(error.message || 'Failed to save item');
    }

    if (!response.ok) {
      const errors = data.errors ? Object.values(data.errors).flat().join(', ') : data.message || 'Failed to save item';
      throw new Error(errors);
    }

    showToast('success', successMessage);
    toggleModal(itemModal, false);
    resetForm();
    await Promise.all([fetchItems(), fetchStats()]);
  }

  async function deleteItem(id) {
    const response = await fetch(endpoints.remove(id), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken(),
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: JSON.stringify({}),
    });

    let data;
    try {
      data = await parseJsonResponse(response);
    } catch (error) {
      throw new Error(error.message || 'Failed to delete item');
    }

    if (!response.ok) {
      throw new Error(data.message || 'Failed to delete item');
    }

    showToast('success', 'Item deleted successfully.');
    await Promise.all([fetchItems(), fetchStats()]);
  }

  filterButtons.forEach((button) => {
    button.addEventListener('click', () => {
      filterButtons.forEach((btn) => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-white', 'text-slate-700');
      });

      button.classList.remove('bg-white', 'text-slate-700');
      button.classList.add('bg-blue-600', 'text-white');

      currentFilter = button.dataset.filter;
      fetchItems();
    });
  });

  refreshButton.addEventListener('click', () => {
    showToast('info', 'Refreshing items...');
    fetchItems();
    fetchStats();
  });

  createButton.addEventListener('click', () => {
    modalTitle.textContent = 'Create Item';
    modalSubtitle.textContent = 'Fill in the details below to add a new item.';
    modalSubmit.textContent = 'Save Item';
    editItemId = null;
    resetForm();
    toggleModal(itemModal, true);
  });

  if (emptyCreateButton) {
    emptyCreateButton.addEventListener('click', () => createButton.click());
  }

  document.getElementById('modal-close').addEventListener('click', () => toggleModal(itemModal, false));
  document.getElementById('modal-cancel').addEventListener('click', () => toggleModal(itemModal, false));

  document.getElementById('delete-cancel').addEventListener('click', () => toggleModal(deleteModal, false));

  document.getElementById('delete-confirm').addEventListener('click', async () => {
    if (!deleteItemId) return;
    try {
      await deleteItem(deleteItemId);
    } catch (error) {
      showToast('error', error.message);
    } finally {
      toggleModal(deleteModal, false);
      deleteItemId = null;
    }
  });

  itemForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const payload = {
      name: nameInput.value,
      price: Number(priceInput.value),
      category: categoryInput.value,
      thumbnail: thumbnailInput.value || '',
      description: descriptionInput.value || '',
      is_featured: featuredInput.checked,
    };

    try {
      if (editItemId) {
        await submitItem(endpoints.update(editItemId), 'POST', payload, 'Item updated successfully.');
      } else {
        await submitItem(endpoints.create, 'POST', payload, 'Item created successfully.');
      }
    } catch (error) {
      showToast('error', error.message);
    }
  });

  itemsContainer.addEventListener('click', (event) => {
    const button = event.target.closest('button');
    if (!button) return;

    const action = button.dataset.action;
    const id = button.dataset.id;

    if (action === 'edit') {
      modalTitle.textContent = 'Update Item';
      modalSubtitle.textContent = 'Make changes to your football item.';
      modalSubmit.textContent = 'Update Item';
      editItemId = id;

      const item = itemsCache.get(id);
      if (item) {
        nameInput.value = item.name || '';
        descriptionInput.value = item.description || '';
        categoryInput.value = (item.category || 'other').toLowerCase();
        priceInput.value = item.price || 0;
        thumbnailInput.value = item.thumbnail || '';
        featuredInput.checked = Boolean(item.is_featured);
      }

      toggleModal(itemModal, true);
    }

    if (action === 'delete') {
      deleteItemId = id;
      toggleModal(deleteModal, true);
    }
  });

  window.addEventListener('click', (event) => {
    if (event.target === itemModal) toggleModal(itemModal, false);
    if (event.target === deleteModal) toggleModal(deleteModal, false);
  });

  fetchItems();
  fetchStats();
</script>
{% endblock content %}
